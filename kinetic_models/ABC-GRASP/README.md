# ABC-GRASP
This folder contains all the necessary scripts and inputs to create the kinetic models. It is divided in:
- GRASP-main
- ensemble_sampling
- ensemble_simulation

Overall, to generate the ensemble models, the scripts located in the subfolders of ensemble_samping must be executed. Input GRASP format files must be placed in GRASP-main/io/input beforehand. The scripts will generate models in the GRASP-main/io/output folder, but they represent the prior ensemble of models. The script GRASP-main/b_car_scripts/filter_ensemble must be run to overwrite the previous outputs and select the best model particles, generating the posterior ensemble models in the GRASP-main/io/output folder. Scripts in the sub-folders of ensemble_simulation allow to simulate the posterior ensemble models. Finally, scripts in GRASP-main/b_car_scripts are included to analyze the results and create figures.

The folders ensemble_sampling and ensemble_simulation are separated from the rest because they were originally run in a Cluster based on Unix. The rest of the codes were executed in a personal computer based on Windows.

## GRASP-main
It is equivalent to the GRASP Toolbox, but with added functions and scripts specific to the creation of beta-carotene production models. Only folders and files with differences are mentioned. The main kinetic model data files are stored in io/output.

#### b_car_scripts
Scripts used to analyze data and create figures:
- filter_ensemble: selects the best model particles of an ensemble model based on the discrepancy scores of simulations and experimental fluxes. It requires a backup file generated by b_car_rejection_X_Y_run.m in the ensemble_sampling subfolder. The posterior ensemble is stored in GRASP-main/io/output. Furthermore, it performs metabolic control analysis of the posterior ensemble.
- flux_control_significance_selection: estimates the significance of flux response coefficients in posterior ensembles.
- metabolite_control_significance_selection: estimates the significance of concentration response coefficients in posterior ensembles.
- plot_control_mean: plots heatmaps of the average control coefficients.
- plot_control_mean_large: plots heatmpas of the average control coefficients, but in a larger size and including the names of metabolites, fluxes, and enzymes.
- plot_control_mean_selection: plot heatmaps of the average control coefficients, but only a selection of them.
- plot_discrepancy_scores_boxplots: creates boxplots of the discrepancy scores.
- plot_fluxes_posterior: plots the fluxes of the posterior ensemble models at non-reference conditions.
- plot_fluxes_prior: plots the fluxes of the prior ensemble models at non-reference conditions.
- plot_metabolites_concentrations: plots the concentration of metabolites using the prior and posterior ensemble models.
- plot_metabolites_concentrations_posterior: plots the concentration of metabolites using the posterior ensemble models.
- plot_metabolites_correlation_posterior: plots a heatmap of the correlation between metabolite concentrations using a posterior ensemble model.
- plot_metabolites_correlation_prior: plots a heatmap of the correlation between metabolite concentrations using a prior ensemble model.
- plot_relative_enzymes: plots the relative abundance of enzymes using the prior and posterior ensemble models.
- plot_relative_enzymes_posterior: plots the relative abundance of enzymes using the posterior ensemble models. 
- plot_relative_enzymes_simulation: plots the relative abundance of enzymes for a simulated perturbation.
- plot_relative_metabolites: plots the relative metabolite concentrations using the prior and posterior ensemble models.
- plot_relative_metabolites_posterior: plots the relative metabolite concentrations using the posterior ensemble models.
- plot_relative_metabolites_simulation: plots the relative metabolite concentrations for a simulated perturbation.
- plot_simulation_fluxes: plots the fluxes for a selected set of simulated perturbations.
- plot_simulation_enzymes_fluxes: plots the fluxes of all enzyme abundance simulated perturbations.
- plot_simulation_metabolites_fluxes: plots the fluxes of all metabolite concentration simulated perturbations.
- plot_second_simulation_enzymes_fluxes: plots the fluxes of all enzyme abundance perturbations in the second round of simulations.
- plot_second_simulation_metabolites_fluxes: plots the fluxes of all metabolite concentration perturbations in the second round of simulation.

#### matlab_code
- analysisFxns/simulateFluxes: new function added to simulate fluxes in non-experimental conditions.
- analysisFxns/controlAndResponseAnalysis: slight changes to prevent error in calculations caused by relatively small values.
- ensembleFxns/buildEnsemble: modificated to include checkpoints. The sampling of models can be re-initialized if there is an error or the environment crashes.
- ensembleFxns/initialSamples: modificated to return information about the calculation of discrepancy scores. It also checks the stabilty and control response accuracy of the sampled models at non-reference conditions
- ensembleFxns/checkStabilityRejection: new function. Similar to checkStability, but it checks non-reference conditions during rejection sampling.

#### patterns
It contains the added reaction patterns of the metabolic pathway in .txt files. Patterns for simple, regulated, and detailed structure types are included.

#### reactions
It contains folders with the reaction functions to calculate the fluxes of the kinetic models. They are divided by growth rate and model structure type. This functions are used both in the sampling and simulation of models.

#### io/input
It stores the .xlsx files used as input for the sampling and selection of models. It also includes the .xlsx files used as input for the simulation of perturbations.

#### io/output
It stores the posterior ensemble models (after rejection process)-

#### io/cr
It stores the control and response analysis of the posterior ensemble models included in io/output.

#### io/unfiltered_output
It stores the prior ensemble models (before rejection process).

#### io/figures
It stores the figures generated by b_car_scripts code.

## ensemble_sampling
Each folder has the inputs and outputs for the sampling of models. The nomenclature of the folder is X_Y, where X stands for the type of structure for the model ensemble, and Y the growth rate of it. The sub-folders contain:
- b_car_rejection_X_Y_run.m: Matlab script to initialize the ensemble sampling using Matlab R2021a in Linux.
- submit_X_Y.sh: shell script to execute the previous matlab script using parallel sampling in Linux via Slurm.
- b_car_rejection_model_X_Y.xlsx: input GRASP-formatted file to generate the models. This file is not the one that is used by GRASP to create the models, but is the same as the one that is located in ../GRASP-main/io/input, which is utilized as input.
- b_car_rejection_X_Y_1 folder: folder with the reaction functions generated by GRASP based on the previous file and the reaction patters located in ../GRASP-main/patterns.
- b_car_rejection_model_X_Y.mat: Matlab data that is the output generated directly by GRASP. This is not the posterior ensemble model (after rejection). This file is generated by default at ../GRASP-main/io/output. To store all the models sampled by GRASP, the discrepancy threshold was set with value enough to prevent the deletion of model particles. The following file and the script filter_ensemble are required to generate the posterior ensemble models.
- backup_b_car_rejection_model_X_Y.mat: Matlab data file with the backup of the sampling process. It stores all the necessary variables to select models based on their discrepancy scores. It is utilized by the script filter_ensemble to generate the posterior ensemble models at ../GRASP-main/io/output. This also generates the prior ensemble models at ../GRASP-main/io/unfiltered_output.
- output_X_Y.txt: text file with messages of the console while using Matlab R2021 mediated via Slurm in Linux. Some text files were rewritten by re-starting the sampling process.

## ensemble_simulation
Each folder has the inputs and outputs for the simulation of models. The nomenclature of the folder is Z_(second)_X_Y, where X stands for the type of structure for the model ensemble, Y the growth rate of it, and Z for the type of perturbations performed. They also indicate if it is the second set of simulations. The sub-folders contain:
- b_car_simulation_Z_(second)_X_Y_run.m: Matlab script to initialize the ensemble simulation using Matlab R2021a in Linux.
- submit_simulation_Z_(second)_X_Y.sh: shell script to execute the previous Matlab script using parallel computation in Linux via Slurm.
- backup_b_car_simulation_Z_(second)_model_X_Y.mat: Matlab data file with the backup of the simulation process. It stores all the necessary variables to create figures and analyze the results.
- b_car_Z_(second)_simulation.xlsx: file with the perturbations to be simulated.
- Z(2)_X_Y.txt: text file with messages of the console while using Matlab R2021 mediated via Slurm in Linux. Some text files were rewritten by re-starting the simulation process. It includes a '2' in the name if it is the second set of simulations.


